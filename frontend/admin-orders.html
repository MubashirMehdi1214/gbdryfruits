<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Orders - GB Dry Fruits</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; }
        .status-badge {
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
        }
        .status-pending { background: #fef3c7; color: #92400e; }
        .status-confirmed { background: #dbeafe; color: #1e40af; }
        .status-processing { background: #e0e7ff; color: #3730a3; }
        .status-shipped { background: #f3e8ff; color: #6b21a8; }
        .status-delivered { background: #d1fae5; color: #065f46; }
        .status-cancelled { background: #fee2e2; color: #991b1b; }
    </style>
</head>
<body class="bg-gray-50">
    <!-- Header -->
    <header class="bg-white shadow-sm border-b">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex justify-between items-center h-16">
                <div class="flex items-center">
                    <h1 class="text-2xl font-bold text-gray-900">Admin Orders</h1>
                </div>
                <div class="flex items-center space-x-4">
                    <span class="text-sm text-gray-600">Total Orders: <span id="totalOrders" class="font-bold">0</span></span>
                    <button onclick="refreshOrders()" class="px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700">
                        Refresh
                    </button>
                </div>
            </div>
        </div>
    </header>

    <!-- Filters -->
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 mt-6">
        <div class="bg-white rounded-lg shadow p-4">
            <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Status Filter</label>
                    <select id="statusFilter" onchange="filterOrders()" class="w-full px-3 py-2 border border-gray-300 rounded-lg">
                        <option value="">All Status</option>
                        <option value="Pending">Pending</option>
                        <option value="Confirmed">Confirmed</option>
                        <option value="Processing">Processing</option>
                        <option value="Shipped">Shipped</option>
                        <option value="Delivered">Delivered</option>
                        <option value="Cancelled">Cancelled</option>
                    </select>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Payment Status</label>
                    <select id="paymentFilter" onchange="filterOrders()" class="w-full px-3 py-2 border border-gray-300 rounded-lg">
                        <option value="">All Payment</option>
                        <option value="Pending">Pending</option>
                        <option value="Completed">Completed</option>
                        <option value="Failed">Failed</option>
                    </select>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Search</label>
                    <input type="text" id="searchInput" placeholder="Order ID, Customer..." class="w-full px-3 py-2 border border-gray-300 rounded-lg">
                </div>
                <div class="flex items-end">
                    <button onclick="searchOrders()" class="w-full px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700">
                        Search
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Orders Table -->
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 mt-6">
        <div class="bg-white rounded-lg shadow overflow-hidden">
            <div class="overflow-x-auto">
                <table class="min-w-full divide-y divide-gray-200">
                    <thead class="bg-gray-50">
                        <tr>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Order ID</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Customer</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Items</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Total</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Payment</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">COD Charges</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Status</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Date</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Actions</th>
                        </tr>
                    </thead>
                    <tbody id="ordersTableBody" class="bg-white divide-y divide-gray-200">
                        <!-- Orders will be loaded here -->
                    </tbody>
                </table>
            </div>
            
            <!-- Loading -->
            <div id="loading" class="text-center py-8 hidden">
                <div class="inline-block animate-spin rounded-full h-8 w-8 border-b-2 border-green-600"></div>
                <p class="mt-2 text-gray-600">Loading orders...</p>
            </div>
            
            <!-- No Orders -->
            <div id="noOrders" class="text-center py-8 hidden">
                <p class="text-gray-600">No orders found</p>
            </div>
        </div>
    </div>

    <!-- Order Details Modal -->
    <div id="orderModal" class="fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full hidden">
        <div class="relative top-20 mx-auto p-5 border w-11/12 md:w-3/4 lg:w-1/2 shadow-lg rounded-lg bg-white">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-lg font-bold text-gray-900">Order Details</h3>
                <button onclick="closeOrderModal()" class="text-gray-400 hover:text-gray-600">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                    </svg>
                </button>
            </div>
            
            <div id="orderDetails" class="space-y-4">
                <!-- Order details will be loaded here -->
            </div>
        </div>
    </div>

    <script>
        let allOrders = [];
        let currentOrder = null;

        // Load orders on page load
        document.addEventListener('DOMContentLoaded', function() {
            loadOrders();
        });

        // Load all orders
        async function loadOrders() {
            try {
                showLoading();
                
                // Always try to load from backend first
                let response = await fetch('http://localhost:5000/api/orders/all/orders', {
                    headers: {
                        'Content-Type': 'application/json'
                    }
                });

                // If that fails, try with token
                if (!response.ok) {
                    const token = localStorage.getItem('adminToken') || localStorage.getItem('token') || 'demo-token';
                    response = await fetch('http://localhost:5000/api/orders/all/orders', {
                        headers: {
                            'Authorization': `Bearer ${token}`,
                            'Content-Type': 'application/json'
                        }
                    });
                }

                if (response.ok) {
                    const data = await response.json();
                    allOrders = data.orders;
                    displayOrders(allOrders);
                    updateTotalCount(data.pagination.total);
                    console.log('Loaded real orders from backend:', data.orders.length);
                } else if (response.status === 401) {
                    // Unauthorized - show login prompt
                    showLoginPrompt();
                } else {
                    throw new Error('Failed to load orders');
                }
            } catch (error) {
                console.error('Error loading orders:', error);
                showBackendNotRunning();
            } finally {
                hideLoading();
            }
        }

        // Load orders from localStorage
        function loadLocalStorageOrders() {
            const storedOrders = JSON.parse(localStorage.getItem('orders') || '[]');
            
            // Convert localStorage format to match expected format
            allOrders = storedOrders.map(order => ({
                _id: order.id,
                user: {
                    name: order.customer.name,
                    email: order.customer.email,
                    phone: order.customer.phone
                },
                orderItems: order.items,
                totalPrice: order.totals.total,
                paymentMethod: order.paymentMethod,
                paymentStatus: 'Pending',
                orderStatus: order.status || 'Pending',
                createdAt: order.createdAt,
                shippingAddress: {
                    name: order.customer.name,
                    phone: order.customer.phone,
                    address: order.customer.address,
                    city: order.customer.city,
                    state: order.customer.city,
                    zipCode: '00000',
                    country: 'Pakistan'
                }
            }));
            
            displayOrders(allOrders);
            updateTotalCount(allOrders.length);
            
            // Show notification that we're using localStorage
            showLocalStorageNotification();
        }

        // Show localStorage notification
        function showLocalStorageNotification() {
            const notification = document.createElement('div');
            notification.className = 'bg-yellow-50 border border-yellow-200 text-yellow-800 px-4 py-3 rounded-lg mb-4';
            notification.innerHTML = `
                <div class="flex items-center">
                    <svg class="w-5 h-5 mr-2" fill="currentColor" viewBox="0 0 20 20">
                        <path fill-rule="evenodd" d="M8.257 3.099c.765-1.36 2.722-1.36 3.486 0l5.58 9.92c.75 1.334-.213 2.98-1.742 2.98H4.42c-1.53 0-2.493-1.646-1.743-2.98l5.58-9.92zM11 13a1 1 0 11-2 0 1 1 0 012 0zm-1-8a1 1 0 00-1 1v3a1 1 0 002 0V6a1 1 0 00-1-1z" clip-rule="evenodd"/>
                    </svg>
                    <span class="text-sm font-medium">Using Local Storage - Backend server not running</span>
                </div>
            `;
            
            const container = document.querySelector('.max-w-7xl');
            container.insertBefore(notification, container.firstChild);
            
            // Remove notification after 5 seconds
            setTimeout(() => {
                notification.remove();
            }, 5000);
        }

        // Show login prompt
        function showLoginPrompt() {
            const email = prompt('Enter admin email:');
            const password = prompt('Enter admin password:');
            
            if (email && password) {
                loginAdmin(email, password);
            } else {
                showSampleOrders();
            }
        }

        // Login admin
        async function loginAdmin(email, password) {
            try {
                const response = await fetch('http://localhost:5000/api/auth/login', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ email, password })
                });

                if (response.ok) {
                    const data = await response.json();
                    localStorage.setItem('adminToken', data.token);
                    loadOrders();
                } else {
                    alert('Login failed. Showing sample data.');
                    showSampleOrders();
                }
            } catch (error) {
                console.error('Login error:', error);
                showSampleOrders();
            }
        }

        // Show connection error
        function showConnectionError() {
            const tbody = document.getElementById('ordersTableBody');
            tbody.innerHTML = `
                <tr>
                    <td colspan="8" class="px-6 py-8 text-center">
                        <div class="text-red-600">
                            <p class="text-lg font-semibold">Backend Server Not Running</p>
                            <p class="text-sm mt-2">Please start the backend server:</p>
                            <code class="block mt-2 text-sm bg-gray-100 p-2 rounded">cd backend<br>npm start</code>
                            <button onclick="showSampleOrders()" class="mt-4 px-4 py-2 bg-blue-600 text-white rounded-lg">
                                Show Sample Data
                            </button>
                        </div>
                    </td>
                </tr>
            `;
        }

        // Show sample orders for demo
        function showSampleOrders() {
            const sampleOrders = [
                {
                    _id: 'GBDRY-123456',
                    user: { name: 'Mubashir Mehdi', email: 'munashirmehdi@mail.com', phone: '+92 311 518 9291' },
                    orderItems: [
                        { name: 'Walnuts Kashmiri', quantity: 2, price: 1800 }
                    ],
                    subtotal: 3600,
                    payment: {
                        gateway: 'cod',
                        deliveryCharges: 0, // Karachi - free COD
                        amount: 3600
                    },
                    totalPrice: 3600,
                    paymentMethod: 'Cash on Delivery',
                    paymentStatus: 'Pending',
                    orderStatus: 'Pending',
                    createdAt: new Date().toISOString(),
                    shippingAddress: {
                        name: 'Mubashir Mehdi',
                        phone: '+92 311 518 9291',
                        address: '123 Main Street',
                        city: 'Karachi',
                        state: 'Sindh'
                    }
                },
                {
                    _id: 'GBDRY-789012',
                    user: { name: 'Ahmed Khan', email: 'ahmed@mail.com', phone: '+92 300 123 4567' },
                    orderItems: [
                        { name: 'Premium Almonds', quantity: 1, price: 1200 },
                        { name: 'Premium Cashews', quantity: 1, price: 1600 }
                    ],
                    subtotal: 2800,
                    payment: {
                        gateway: 'cod',
                        deliveryCharges: 150, // Peshawar - Rs.150 COD charges
                        amount: 2950
                    },
                    totalPrice: 2950,
                    paymentMethod: 'Cash on Delivery',
                    paymentStatus: 'Completed',
                    orderStatus: 'Processing',
                    createdAt: new Date(Date.now() - 86400000).toISOString(),
                    shippingAddress: {
                        name: 'Ahmed Khan',
                        phone: '+92 300 123 4567',
                        address: '456 Market Road',
                        city: 'Peshawar',
                        state: 'KPK'
                    }
                },
                {
                    _id: 'GBDRY-345678',
                    user: { name: 'Fatima Ali', email: 'fatima@mail.com', phone: '+92 321 987 6543' },
                    orderItems: [
                        { name: 'Pistachios Salted', quantity: 1, price: 2500 }
                    ],
                    subtotal: 2500,
                    payment: {
                        gateway: 'jazzcash',
                        deliveryCharges: 0, // Online payment - no COD charges
                        amount: 2500
                    },
                    totalPrice: 2500,
                    paymentMethod: 'JazzCash',
                    paymentStatus: 'Completed',
                    orderStatus: 'Shipped',
                    createdAt: new Date(Date.now() - 172800000).toISOString(),
                    shippingAddress: {
                        name: 'Fatima Ali',
                        phone: '+92 321 987 6543',
                        address: '789 Garden Avenue',
                        city: 'Lahore',
                        state: 'Punjab'
                    }
                }
            ];
            
            allOrders = sampleOrders;
            displayOrders(allOrders);
            updateTotalCount(allOrders.length);
        }

        // Display orders in table
        function displayOrders(orders) {
            const tbody = document.getElementById('ordersTableBody');
            const noOrders = document.getElementById('noOrders');
            
            if (orders.length === 0) {
                tbody.innerHTML = '';
                noOrders.classList.remove('hidden');
                return;
            }
            
            noOrders.classList.add('hidden');
            
            tbody.innerHTML = orders.map(order => `
                <tr class="hover:bg-gray-50">
                    <td class="px-6 py-4 whitespace-nowrap">
                        <span class="text-sm font-medium text-gray-900">#${(order._id || order.id || '').slice(-6)}</span>
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap">
                        <div class="text-sm font-medium text-gray-900">${order.customer?.name || order.user?.name || 'Guest'}</div>
                        <div class="text-sm text-gray-500">${order.customer?.email || order.user?.email || 'N/A'}</div>
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap">
                        <div class="text-sm text-gray-900">${order.orderItems?.length || 0} items</div>
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap">
                        <span class="text-sm font-medium text-gray-900">Rs. ${order.totalPrice?.toLocaleString() || 0}</span>
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap">
                        <span class="status-badge ${getStatusClass(order.paymentStatus || order.payment?.status)}">${order.paymentStatus || order.payment?.status || 'Pending'}</span>
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap">
                        <span class="text-sm text-gray-900">
                            ${order.payment?.deliveryCharges > 0 ? 
                                `Rs. ${order.payment.deliveryCharges?.toLocaleString() || 0}` : 
                                order.shippingPrice > 0 ? 
                                    `Rs. ${order.shippingPrice?.toLocaleString() || 0}` :
                                    'Free'
                            }
                        </span>
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap">
                        <span class="status-badge ${getStatusClass(order.orderStatus || order.status)}">${order.orderStatus || order.status || 'Pending'}</span>
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
                        ${new Date(order.createdAt).toLocaleDateString()}
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm font-medium">
                        <button onclick="viewOrder('${order._id}')" class="text-blue-600 hover:text-blue-900 mr-3">View</button>
                        <button onclick="updateOrderStatus('${order._id}')" class="text-green-600 hover:text-green-900">Update</button>
                    </td>
                </tr>
            `).join('');
        }

        // Get status class for styling
        function getStatusClass(status) {
            return `status-${status?.toLowerCase() || 'pending'}`;
        }

        // Update total count
        function updateTotalCount(count) {
            document.getElementById('totalOrders').textContent = count;
        }

        // View order details
        function viewOrder(orderId) {
            const order = allOrders.find(o => o._id === orderId);
            if (!order) return;
            
            currentOrder = order;
            
            const detailsHtml = `
                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <h4 class="font-semibold text-gray-900 mb-2">Order Information</h4>
                        <p class="text-sm"><strong>Order ID:</strong> #${order._id.slice(-6)}</p>
                        <p class="text-sm"><strong>Date:</strong> ${new Date(order.createdAt).toLocaleDateString()}</p>
                        <p class="text-sm"><strong>Payment Method:</strong> ${order.paymentMethod || 'COD'}</p>
                        <p class="text-sm"><strong>Subtotal:</strong> Rs. ${order.itemsPrice?.toLocaleString() || order.subtotal?.toLocaleString() || 0}</p>
                        ${order.payment?.deliveryCharges > 0 ? 
                            `<p class="text-sm"><strong>COD Charges:</strong> Rs. ${order.payment.deliveryCharges?.toLocaleString() || 0}</p>` : 
                            order.shippingPrice > 0 ? 
                                `<p class="text-sm"><strong>Shipping:</strong> Rs. ${order.shippingPrice?.toLocaleString() || 0}</p>` :
                                '<p class="text-sm"><strong>Shipping:</strong> Free</p>'
                        }
                        <p class="text-sm font-semibold"><strong>Total:</strong> Rs. ${order.totalPrice?.toLocaleString() || 0}</p>
                    </div>
                    <div>
                        <h4 class="font-semibold text-gray-900 mb-2">Customer Information</h4>
                        <p class="text-sm"><strong>Name:</strong> ${order.customer?.name || order.user?.name || 'Guest'}</p>
                        <p class="text-sm"><strong>Email:</strong> ${order.customer?.email || order.user?.email || 'N/A'}</p>
                        <p class="text-sm"><strong>Phone:</strong> ${order.customer?.phone || order.shippingAddress?.phone || 'N/A'}</p>
                    </div>
                </div>
                
                <div>
                    <h4 class="font-semibold text-gray-900 mb-2">Shipping Address</h4>
                    <p class="text-sm">${order.shippingAddress?.address}, ${order.shippingAddress?.city}, ${order.shippingAddress?.state}</p>
                </div>
                
                <div>
                    <h4 class="font-semibold text-gray-900 mb-2">Order Items</h4>
                    <div class="space-y-2">
                        ${order.orderItems?.map(item => `
                            <div class="flex justify-between text-sm">
                                <span>${item.name || item.product?.name} Ã— ${item.quantity}</span>
                                <span>Rs. ${(item.price * item.quantity).toLocaleString()}</span>
                            </div>
                        `).join('') || '<p class="text-sm text-gray-500">No items</p>'}
                    </div>
                </div>
                
                <div class="flex justify-end space-x-3">
                    <button onclick="updateOrderStatus('${order._id}')" class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700">
                        Update Status
                    </button>
                </div>
            `;
            
            document.getElementById('orderDetails').innerHTML = detailsHtml;
            document.getElementById('orderModal').classList.remove('hidden');
        }

        // Close order modal
        function closeOrderModal() {
            document.getElementById('orderModal').classList.add('hidden');
            currentOrder = null;
        }

        // Update order status
        async function updateOrderStatus(orderId) {
            const order = allOrders.find(o => o._id === orderId);
            if (!order) return;
            
            const newStatus = prompt(`Update status for order #${orderId.slice(-6)}:\n\nCurrent: ${order.orderStatus}\n\nEnter new status:\n(Pending, Confirmed, Processing, Shipped, Delivered, Cancelled)`);
            
            if (newStatus && ['Pending', 'Confirmed', 'Processing', 'Shipped', 'Delivered', 'Cancelled'].includes(newStatus)) {
                try {
                    const token = localStorage.getItem('adminToken') || localStorage.getItem('token') || 'demo-token';
                    
                    const response = await fetch(`http://localhost:5000/api/orders/${orderId}/status`, {
                        method: 'PUT',
                        headers: {
                            'Authorization': `Bearer ${token}`,
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({ 
                            orderStatus: newStatus,
                            trackingNumber: newStatus === 'Shipped' ? `TRK${Date.now().toString().slice(-6)}` : order.trackingNumber
                        })
                    });

                    if (response.ok) {
                        const result = await response.json();
                        // Update local order data
                        order.orderStatus = newStatus;
                        order.trackingNumber = result.order.trackingNumber;
                        displayOrders(allOrders);
                        closeOrderModal();
                        alert(`Order status updated to ${newStatus}`);
                    } else {
                        alert('Failed to update status. Please try again.');
                    }
                } catch (error) {
                    console.error('Error updating order status:', error);
                    alert('Error updating status. Please try again.');
                }
            }
        }

        // Filter orders
        function filterOrders() {
            const statusFilter = document.getElementById('statusFilter').value;
            const paymentFilter = document.getElementById('paymentFilter').value;
            
            let filtered = allOrders;
            
            if (statusFilter) {
                filtered = filtered.filter(order => order.orderStatus === statusFilter);
            }
            
            if (paymentFilter) {
                filtered = filtered.filter(order => order.paymentStatus === paymentFilter);
            }
            
            displayOrders(filtered);
        }

        // Search orders
        function searchOrders() {
            const searchTerm = document.getElementById('searchInput').value.toLowerCase();
            
            if (!searchTerm) {
                displayOrders(allOrders);
                return;
            }
            
            const filtered = allOrders.filter(order => 
                order._id.toLowerCase().includes(searchTerm) ||
                (order.user?.name && order.user.name.toLowerCase().includes(searchTerm)) ||
                (order.user?.email && order.user.email.toLowerCase().includes(searchTerm))
            );
            
            displayOrders(filtered);
        }

        // Refresh orders
        function refreshOrders() {
            loadOrders();
        }

        // Show/hide loading
        function showLoading() {
            document.getElementById('loading').classList.remove('hidden');
        }

        function hideLoading() {
            document.getElementById('loading').classList.add('hidden');
        }
    </script>
</body>
</html>
