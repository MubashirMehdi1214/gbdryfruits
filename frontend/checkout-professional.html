<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Secure Checkout - GB Dry Fruits Premium</title>
    <meta name="description" content="Secure checkout with multiple payment options. COD, JazzCash, EasyPaisa, Stripe, PayPal accepted.">
    <meta name="robots" content="noindex, nofollow">
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Custom Tailwind Config -->
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: '#2D5016',
                        secondary: '#8B4513',
                        accent: '#D4A574',
                        cream: '#FAF7F0',
                        success: '#27AE60',
                        warning: '#F39C12',
                        danger: '#E74C3C'
                    },
                    fontFamily: {
                        sans: ['Inter', 'system-ui', 'sans-serif']
                    }
                }
            }
        }
    </script>
    
    <!-- External Libraries -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    <script src="https://js.stripe.com/v3/"></script>
    <script src="https://www.paypal.com/sdk/js?client-id=AU4Hk1n6v6GjT3Q9ZfK1s1l-1w1tHzv&currency=PKR"></script>
    
    <style>
        body { 
            font-family: 'Inter', sans-serif; 
            background: linear-gradient(135deg, #FAF7F0 0%, #F5F0E6 100%);
            font-size: 14px; /* Reduced from default 16px by ~12.5% */
        }
        
        /* GLOBAL ICON CONSTRAINTS */
        svg, img, i, .icon {
            max-width: 24px !important;
            height: auto !important;
            width: auto !important;
            object-fit: contain;
        }

        .brand-logo {
            max-width: none !important;
            height: 32px !important;
            width: auto !important;
        }

        .media-large {
            max-width: none !important;
            width: 48px !important;
            height: 48px !important;
        }
        
        .icon-small {
            max-width: 18px !important;
            height: auto !important;
        }
        
        .icon-large {
            max-width: 32px !important;
            height: auto !important;
        }
        
        /* PAYMENT ICONS */
        .payment-icon {
            width: 40px;
            height: 24px;
            display: flex;
            align-items: center;
            justify-content: center;
            background: white;
            border-radius: 6px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }
        
        /* STEP INDICATORS */
        .step-indicator {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 600;
            font-size: 12px; /* Reduced from 14px */
            transition: all 0.3s ease;
        }
        
        .step-indicator.active {
            background: linear-gradient(135deg, #2D5016 0%, #1a3408 100%);
            box-shadow: 0 4px 12px rgba(45, 80, 22, 0.3);
        }
        
        .step-line {
            height: 2px;
            background: #e5e7eb;
            flex: 1;
        }
        
        .step-line.active {
            background: linear-gradient(90deg, #2D5016 0%, #27AE60 100%);
        }
        
        /* CARD STYLING */
        .checkout-card {
            background: white;
            border-radius: 12px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
            border: 1px solid #f3f4f6;
        }
        
        .form-input {
            border: 1px solid #e5e7eb;
            border-radius: 8px;
            padding: 12px 16px;
            font-size: 15px;
            transition: all 0.2s ease;
        }
        
        .form-input:focus {
            outline: none;
            border-color: #2D5016;
            box-shadow: 0 0 0 3px rgba(45, 80, 22, 0.1);
        }
        
        .btn-primary {
            background: linear-gradient(135deg, #2D5016 0%, #1a3408 100%);
            color: white;
            padding: 14px 24px;
            border-radius: 8px;
            font-weight: 600;
            transition: all 0.2s ease;
            box-shadow: 0 4px 12px rgba(45, 80, 22, 0.3);
        }
        
        .btn-primary:hover {
            transform: translateY(-1px);
            box-shadow: 0 6px 16px rgba(45, 80, 22, 0.4);
        }
        
        .btn-secondary {
            background: white;
            color: #6b7280;
            padding: 14px 24px;
            border-radius: 8px;
            font-weight: 500;
            border: 1px solid #e5e7eb;
            transition: all 0.2s ease;
        }
        
        .btn-secondary:hover {
            background: #f9fafb;
            border-color: #d1d5db;
        }
        
        /* PAYMENT GRID */
        .payment-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 16px;
        }
        
        .payment-option {
            background: white;
            border: 2px solid #e5e7eb;
            border-radius: 12px;
            padding: 20px;
            cursor: pointer;
            transition: all 0.3s ease;
            text-align: center;
        }
        
        .payment-option:hover {
            border-color: #2D5016;
            box-shadow: 0 8px 25px rgba(45, 80, 22, 0.15);
            transform: translateY(-2px);
        }
        
        .payment-option.selected {
            border-color: #2D5016;
            background: linear-gradient(135deg, #FAF7F0 0%, #F5F0E6 100%);
            box-shadow: 0 4px 12px rgba(45, 80, 22, 0.1);
        }
        
        /* STICKY SUMMARY */
        .sticky-summary {
            position: sticky;
            top: 20px;
        }
        
        /* RESPONSIVE */
        @media (max-width: 768px) {
            .checkout-grid {
                grid-template-columns: 1fr;
                gap: 20px;
            }
            
            .sticky-summary {
                position: relative;
                top: 0;
            }
            
            .payment-grid {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body class="min-h-screen">
    <!-- SSL Security Banner -->
    <div class="bg-gradient-to-r from-green-600 to-green-700 text-white py-3">
        <div class="container mx-auto px-4 flex items-center justify-center">
            <svg class="w-5 h-5 mr-2" fill="currentColor" viewBox="0 0 20 20">
                <path fill-rule="evenodd" d="M2.166 4.999A11.954 11.954 0 0010 1.944 11.954 11.954 0 0017.834 5c.11.65.166 1.32.166 1.971 0 3.212-2.206 4.815-4.156 4.815a2.007 2.007 0 01-1.447-.623C8.923 8.8 8.022 8.5 7 8.5c-3.314 0-6 2.686-6 6 0 2.651 1.732 4.9 4.142 5.683a2.007 2.007 0 011.447-.623c1.95 0 4.156 1.603 4.156 4.815 0 1.65-.056 3.321-.166 1.971z" clip-rule="evenodd"/>
            </svg>
            <span class="font-semibold">üîí SECURE SSL ENCRYPTED CHECKOUT - 256-BIT ENCRYPTION</span>
        </div>
    </div>

    <!-- Header -->
    <header class="bg-white border-b border-gray-200">
        <div class="container mx-auto px-4 py-4">
            <div class="flex items-center justify-between">
                <div class="flex items-center space-x-3">
                    <img src="images/LOGO.png" alt="GBDRYFRUITS" class="brand-logo mr-3">
                    <span class="text-xl font-bold text-gray-900">GBDRYFRUITS</span>
                    <span class="text-sm text-gray-500 ml-auto">Mubashir Mehdi, Owner</span>
                </div>
                <div class="flex items-center space-x-6 text-sm text-gray-600">
                    <div class="flex items-center">
                        <svg class="w-4 h-4 mr-1 text-green-600" fill="currentColor" viewBox="0 0 20 20">
                            <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 0l-2 2a1 1 0 101.414 1.414L8.586 10l1.293 1.293a1 1 0 001.414-1.414l-2-2z" clip-rule="evenodd"/>
                        </svg>
                        100% Secure
                    </div>
                    <div class="flex items-center">
                        <svg class="w-4 h-4 mr-1 text-green-600" fill="currentColor" viewBox="0 0 20 20">
                            <path d="M2 6a2 2 0 012-2h5l2 2h5a2 2 0 012 2v6a2 2 0 01-2 2H4a2 2 0 01-2-2V6z"/>
                        </svg>
                        Fast Delivery
                    </div>
                </div>
            </div>
        </div>
    </header>

    <!-- Main Content -->
    <main class="container mx-auto px-4 py-8">
        <!-- Progress Steps -->
        <div class="mb-8">
            <div class="flex items-center justify-between max-w-3xl mx-auto">
                <div class="flex items-center">
                    <div class="step-indicator active" id="step1">1</div>
                    <div class="ml-4">
                        <div class="font-semibold text-gray-900">Shipping</div>
                        <div class="text-sm text-gray-600">Delivery address</div>
                    </div>
                </div>
                <div class="step-line active"></div>
                <div class="flex items-center">
                    <div class="step-indicator bg-gray-200 text-gray-500" id="step2">2</div>
                    <div class="ml-4">
                        <div class="font-semibold text-gray-500">Payment</div>
                        <div class="text-sm text-gray-500">Choose method</div>
                    </div>
                </div>
                <div class="step-line"></div>
                <div class="flex items-center">
                    <div class="step-indicator bg-gray-200 text-gray-500" id="step3">3</div>
                    <div class="ml-4">
                        <div class="font-semibold text-gray-500">Review</div>
                        <div class="text-sm text-gray-500">Confirm order</div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Checkout Grid -->
        <div class="checkout-grid grid grid-cols-1 lg:grid-cols-3 gap-8">
            <!-- Left Column: Multi-Step Form -->
            <div class="lg:col-span-2">
                <!-- Step 1: Shipping -->
                <div id="shippingStep" class="checkout-card p-8">
                    <h2 class="text-xl font-bold text-gray-900 mb-6">Shipping Information</h2>
                    
                    <form id="shippingForm" class="space-y-6">
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">First Name</label>
                                <input type="text" name="firstName" required class="form-input w-full" placeholder="John">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Last Name</label>
                                <input type="text" name="lastName" required class="form-input w-full" placeholder="Doe">
                            </div>
                        </div>
                        
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Email Address</label>
                            <input type="email" name="email" required class="form-input w-full" placeholder="munashirmehdi@mail.com">
                        </div>
                        
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Phone Number</label>
                            <div class="flex gap-2">
                                <select name="countryCode" class="form-input flex-shrink-0">
                                    <option value="+92">+92 (PK)</option>
                                    <option value="+1">+1 (US)</option>
                                    <option value="+44">+44 (UK)</option>
                                </select>
                                <input type="tel" name="phone" required class="form-input flex-1" placeholder="311 518 9291">
                            </div>
                        </div>
                        
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Complete Address</label>
                            <textarea name="address" rows="3" required class="form-input w-full" placeholder="House #, Street, Area"></textarea>
                        </div>
                        
                        <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">City</label>
                                <select name="city" required class="form-input w-full" id="citySelect">
                                    <option value="">Select City</option>
                                    <option value="karachi">Karachi</option>
                                    <option value="lahore">Lahore</option>
                                    <option value="islamabad">Islamabad</option>
                                    <option value="rawalpindi">Rawalpindi</option>
                                    <option value="faisalabad">Faisalabad</option>
                                    <option value="multan">Multan</option>
                                    <option value="peshawar">Peshawar</option>
                                    <option value="quetta">Quetta</option>
                                    <option value="international">International (Outside Pakistan)</option>
                                </select>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Postal Code</label>
                                <input type="text" name="postalCode" class="form-input w-full" placeholder="74000">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Shipping Method</label>
                                <select name="shippingMethod" required class="form-input w-full" id="shippingMethod">
                                    <option value="Local Pakistan">Local Pakistan (2-5 days)</option>
                                    <option value="International Alibaba">International (7-21 days)</option>
                                </select>
                            </div>
                        </div>
                        
                        <div class="flex justify-end mt-8">
                            <button type="button" onclick="proceedToPayment()" class="btn-primary">
                                Continue to Payment ‚Üí
                            </button>
                        </div>
                    </form>
                </div>

                <!-- Step 2: Payment (Hidden Initially) -->
                <div id="paymentStep" class="checkout-card p-8 hidden">
                    <h2 class="text-xl font-bold text-gray-900 mb-6">Choose Payment Method</h2>
                    
                    <div class="space-y-8">
                        <!-- Cash on Delivery -->
                        <div class="payment-option" onclick="selectPaymentMethod('cod')">
                            <div class="payment-icon">
                                <span class="text-2xl">üíµ</span>
                            </div>
                            <div class="mt-4">
                                <h3 class="font-bold text-gray-900">Cash on Delivery</h3>
                                <p class="text-sm text-gray-600">Pay when you receive your order</p>
                                <div class="flex items-center mt-2">
                                    <svg class="w-4 h-4 text-green-600" fill="currentColor" viewBox="0 0 20 20">
                                        <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 0l-2 2a1 1 0 101.414 1.414L8.586 10l1.293 1.293a1 1 0 001.414-1.414l-2-2z" clip-rule="evenodd"/>
                                    </svg>
                                    <span class="text-sm font-medium text-green-600">Available in your city</span>
                                </div>
                            </div>
                            <div class="text-right">
                                <span class="text-2xl font-bold text-orange-600">+Rs. 250</span>
                            </div>
                        </div>

                        <!-- Pakistani Digital Wallets -->
                        <div>
                            <h3 class="text-lg font-semibold text-gray-900 mb-4">Pakistani Digital Wallets</h3>
                            <div class="payment-grid">
                                <div class="payment-option" onclick="selectPaymentMethod('jazzcash')">
                                    <div class="payment-icon bg-blue-600">
                                        <span class="text-white font-bold">JC</span>
                                    </div>
                                    <div class="mt-3">
                                        <h4 class="font-semibold text-gray-900">JazzCash</h4>
                                        <p class="text-sm text-gray-600">Instant payment</p>
                                    </div>
                                </div>
                                
                                <div class="payment-option" onclick="selectPaymentMethod('easypaisa')">
                                    <div class="payment-icon bg-green-600">
                                        <span class="text-white font-bold">EP</span>
                                    </div>
                                    <div class="mt-3">
                                        <h4 class="font-semibold text-gray-900">EasyPaisa</h4>
                                        <p class="text-sm text-gray-600">Quick & easy</p>
                                    </div>
                                </div>
                                
                                <div class="payment-option" onclick="selectPaymentMethod('meezan')">
                                    <div class="payment-icon bg-indigo-600">
                                        <span class="text-white font-bold">MZ</span>
                                    </div>
                                    <div class="mt-3">
                                        <h4 class="font-semibold text-gray-900">Meezan Bank</h4>
                                        <p class="text-sm text-gray-600">Islamic banking</p>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- International Cards -->
                        <div>
                            <h3 class="text-lg font-semibold text-gray-900 mb-4">International Cards</h3>
                            <div class="payment-grid">
                                <div class="payment-option" onclick="selectPaymentMethod('visa')">
                                    <div class="payment-icon bg-blue-700">
                                        <span class="text-white font-bold">VISA</span>
                                    </div>
                                    <div class="mt-3">
                                        <h4 class="font-semibold text-gray-900">Visa Card</h4>
                                        <p class="text-sm text-gray-600">Debit/Credit</p>
                                    </div>
                                </div>
                                
                                <div class="payment-option" onclick="selectPaymentMethod('mastercard')">
                                    <div class="payment-icon bg-red-600">
                                        <span class="text-white font-bold">MC</span>
                                    </div>
                                    <div class="mt-3">
                                        <h4 class="font-semibold text-gray-900">MasterCard</h4>
                                        <p class="text-sm text-gray-600">Debit/Credit</p>
                                    </div>
                                </div>
                                
                                <div class="payment-option" onclick="selectPaymentMethod('unionpay')">
                                    <div class="payment-icon bg-red-700">
                                        <span class="text-white font-bold">UP</span>
                                    </div>
                                    <div class="mt-3">
                                        <h4 class="font-semibold text-gray-900">UnionPay</h4>
                                        <p class="text-sm text-gray-600">International cards</p>
                                    </div>
                                </div>
                                
                                <div class="payment-option" onclick="selectPaymentMethod('bank-transfer')">
                                    <div class="payment-icon bg-gray-700">
                                        <span class="text-white font-bold">BT</span>
                                    </div>
                                    <div class="mt-3">
                                        <h4 class="font-semibold text-gray-900">Bank Transfer</h4>
                                        <p class="text-sm text-gray-600">Direct deposit</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="flex justify-between mt-8" id="paymentButtons" style="display: none;">
                        <button type="button" onclick="goBackToShipping()" class="btn-secondary">
                            ‚Üê Back to Shipping
                        </button>
                        <button type="button" onclick="proceedToReview()" class="btn-primary">
                            Continue to Review ‚Üí
                        </button>
                    </div>
                </div>

                <!-- Step 3: Review (Hidden Initially) -->
                <div id="reviewStep" class="checkout-card p-8 hidden">
                    <h2 class="text-xl font-bold text-gray-900 mb-6">Review Your Order</h2>
                    
                    <div class="space-y-6">
                        <!-- Order Items -->
                        <div class="border border-gray-200 rounded-lg p-6">
                            <h3 class="font-semibold text-gray-900 mb-4">Order Summary</h3>
                            <div id="reviewOrderItems" class="space-y-3">
                                <!-- Order items will be inserted here -->
                            </div>
                        </div>
                        
                        <!-- Shipping Details -->
                        <div class="border border-gray-200 rounded-lg p-6">
                            <h3 class="font-semibold text-gray-900 mb-4">Shipping Details</h3>
                            <div id="reviewShippingDetails" class="space-y-2 text-sm">
                                <!-- Shipping details will be inserted here -->
                            </div>
                        </div>
                        
                        <!-- Trust Badges -->
                        <div class="bg-green-50 border border-green-200 rounded-lg p-4">
                            <div class="flex items-center justify-center space-x-6 text-sm">
                                <div class="flex items-center">
                                    <svg class="w-5 h-5 text-green-600" fill="currentColor" viewBox="0 0 20 20">
                                        <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 0l-2 2a1 1 0 101.414 1.414L8.586 10l1.293 1.293a1 1 0 001.414-1.414l-2-2z" clip-rule="evenodd"/>
                                    </svg>
                                    <span class="font-medium text-green-600">256-bit SSL Encryption</span>
                                </div>
                                <div class="flex items-center">
                                    <svg class="w-5 h-5 text-green-600" fill="currentColor" viewBox="0 0 20 20">
                                        <path d="M9 2a1 1 0 000 2h2a1 1 0 100-2H9z"/>
                                        <path fill-rule="evenodd" d="M4 5a2 2 0 012-2 1 1 0 011 1v8a2 2 0 01-2 2H6a2 2 0 01-2-2V5a3 3 0 013-3h4a3 3 0 013 3v8a3 3 0 01-3 3H6a3 3 0 01-3-3V5z" clip-rule="evenodd"/>
                                    </svg>
                                    <span class="font-medium text-green-600">Fraud Protection</span>
                                </div>
                                <div class="flex items-center">
                                    <svg class="w-5 h-5 text-green-600" fill="currentColor" viewBox="0 0 20 20">
                                        <path d="M2 6a2 2 0 012-2h5l2 2h5a2 2 0 012 2v6a2 2 0 01-2 2H4a2 2 0 01-2-2V6z"/>
                                    </svg>
                                    <span class="font-medium text-green-600">Money Back Guarantee</span>
                                </div>
                            </div>
                        </div>
                        
                        <div class="flex justify-between mt-8">
                            <button type="button" onclick="goBackToPayment()" class="btn-secondary">
                                ‚Üê Back to Payment
                            </button>
                            <button type="button" onclick="placeOrder()" class="btn-primary">
                                Place Order ‚úì
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Right Column: Order Summary -->
            <div class="lg:col-span-1">
                <div class="sticky-summary checkout-card p-6">
                    <h3 class="text-lg font-semibold text-gray-900 mb-6">Order Summary</h3>
                    
                    <!-- Cart Items Summary -->
                    <div id="sidebarOrderItems" class="space-y-4 mb-6">
                        <!-- Order items will be inserted here -->
                    </div>
                    
                    <!-- Price Breakdown -->
                    <div class="border-t border-gray-200 pt-4 space-y-3">
                        <div class="flex justify-between text-sm">
                            <span class="text-gray-600">Subtotal</span>
                            <span class="font-medium" id="sidebarSubtotal">Rs. 0</span>
                        </div>
                        <div class="flex justify-between text-sm">
                            <span class="text-gray-600">Shipping</span>
                            <span class="font-medium text-gray-600" id="sidebarShipping">Select Payment Method</span>
                        </div>
                        <div class="flex justify-between text-sm" id="discountRow" style="display: none;">
                            <span class="text-gray-600">Discount</span>
                            <span class="font-medium text-red-600" id="sidebarDiscount">-Rs. 0</span>
                        </div>
                        <div class="border-t border-gray-200 pt-3">
                            <div class="flex justify-between">
                                <span class="text-lg font-bold text-gray-900">Total</span>
                                <span class="text-lg font-bold text-green-600" id="sidebarTotal">Rs. 0</span>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Continue to Review Button (Hidden Initially) -->
                    <div class="mt-6" id="sidebarContinueButton" style="display: none;">
                        <button type="button" onclick="proceedToReview()" class="w-full btn-primary">
                            Continue to Review ‚Üí
                        </button>
                    </div>
                    
                    <!-- Place Order Button (Hidden Initially) -->
                    <div class="mt-4" id="sidebarPlaceOrderButton" style="display: none;">
                        <button type="button" onclick="placeOrder()" class="w-full btn-primary">
                            Place Order
                        </button>
                    </div>
                    
                    <!-- Trust Indicators -->
                    <div class="mt-6 space-y-3">
                        <div class="flex items-center justify-center text-xs text-gray-600">
                            <svg class="w-4 h-4 mr-2 text-green-600" fill="currentColor" viewBox="0 0 20 20">
                                <path fill-rule="evenodd" d="M5 9V7a5 5 0 0110 0h2a1 1 0 100-2H5a5 5 0 0110 0v2a2 2 0 01-2 2H5a2 2 0 01-2-2z" clip-rule="evenodd"/>
                            </svg>
                            <span>Secure SSL Certificate</span>
                        </div>
                        <div class="flex items-center justify-center text-xs text-gray-600">
                            <svg class="w-4 h-4 mr-2 text-green-600" fill="currentColor" viewBox="0 0 20 20">
                                <path d="M8 16.5a1.5 1.5 0 11-3 0 1.5 1.5 0 000-3 0z"/>
                            </svg>
                            <span>Verified Merchant</span>
                        </div>
                        <div class="flex items-center justify-center text-xs text-gray-600">
                            <svg class="w-4 h-4 mr-2 text-green-600" fill="currentColor" viewBox="0 0 20 20">
                                <path d="M4 4a2 2 0 012-2h5L2 2h5a2 2 0 012 2v6a2 2 0 01-2 2H4a2 2 0 01-2-2V6z"/>
                            </svg>
                            <span>Cash on Delivery</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <!-- Footer -->
    <footer class="bg-white border-t border-gray-200 mt-12">
        <div class="container mx-auto px-4 py-6">
            <div class="text-center text-sm text-gray-600">
                <p>&copy; 2024 GB Dry Fruits. All rights reserved.</p>
                <div class="flex items-center justify-center space-x-4 mt-2">
                    <span>Owner: Mubashir Mehdi</span>
                    <span>‚Ä¢</span>
                    <span>Email: munashirmehdi@mail.com</span>
                    <span>‚Ä¢</span>
                    <span>Phone: +923115189291</span>
                </div>
                <div class="flex items-center justify-center space-x-4 mt-2">
                    <span>Meezan Bank Account: 03810104256225</span>
                    <span>‚Ä¢</span>
                    <span>WhatsApp: +923115189291</span>
                </div>
                <div class="flex items-center justify-center space-x-4 mt-2">
                    <span>Powered by Secure Payment Gateway</span>
                    <span>‚Ä¢</span>
                    <span>256-bit SSL Encryption</span>
                    <span>‚Ä¢</span>
                    <span>Fraud Protection</span>
                </div>
            </div>
        </div>
    </footer>

    <!-- Loading Overlay -->
    <div id="loadingOverlay" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden">
        <div class="bg-white rounded-xl p-8 flex flex-col items-center space-y-4">
            <div class="w-12 h-12 border-4 border-green-600 border-t-transparent rounded-full animate-spin"></div>
            <p class="text-gray-700 font-medium">Processing your payment...</p>
            <p class="text-sm text-gray-500">Please do not close this window</p>
        </div>
    </div>

    <!-- Bank Transfer Details Modal -->
    <div id="bankTransferModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden">
        <div class="bg-white rounded-xl p-8 max-w-md w-full mx-4">
            <h3 class="text-xl font-bold text-gray-900 mb-4">INSTRUCTIONS FOR BANK TRANSFER:</h3>
            <p class="text-gray-600 mb-4">Please transfer/deposit the order amount to the following bank account and WhatsApp or E-mail the deposit receipt to confirm your order.</p>
            
            <div class="bg-gray-50 p-4 rounded-lg space-y-2 mb-4">
                <p class="text-gray-800 font-semibold">WhatsApp: +92 311 518 9291</p>
                <p class="text-gray-800 font-semibold">E-mail: munashirmehdi@mail.com</p>
            </div>
            
            <div class="border-t border-b border-gray-300 py-4 my-4">
                <div class="space-y-2">
                    <p class="text-gray-800 font-bold text-lg">GBDRYFRUITS</p>
                    <p class="text-gray-600"><strong>Bank Name:</strong> Meezan Bank</p>
                    <p class="text-gray-600"><strong>Account Title:</strong> Mubashir Mehdi</p>
                    <p class="text-gray-600"><strong>Account Number:</strong> 03810104256225</p>
                    <p class="text-gray-600"><strong>IBAN Number:</strong> PK45MEZN0001234567890123</p>
                    <p class="text-gray-600"><strong>Branch Code:</strong> 0381</p>
                </div>
            </div>
            
            <div class="bg-yellow-50 border border-yellow-200 p-3 rounded-lg">
                <p class="text-sm text-yellow-800"><strong>Note:</strong> Your order will be processed after payment confirmation. Thanks</p>
            </div>
            
            <div class="flex justify-end mt-6 space-x-3">
                <button onclick="closeBankTransferModal()" class="btn-secondary">Close</button>
                <button onclick="confirmBankTransfer()" class="btn-primary">Continue to Review ‚Üí</button>
            </div>
        </div>
    </div>

    <!-- JazzCash Payment Modal -->
    <div id="jazzcashModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden">
        <div class="bg-white rounded-xl p-6 max-w-md w-full mx-4 max-h-[90vh] overflow-y-auto">
            <h3 class="text-lg font-bold text-gray-900 mb-3">INSTRUCTIONS FOR JAZZCASH PAYMENT:</h3>
            <p class="text-sm text-gray-600 mb-3">Please transfer the order amount via JazzCash and WhatsApp or E-mail the transaction screenshot to confirm your order.</p>
            
            <div class="bg-gray-50 p-3 rounded-lg space-y-2 mb-3">
                <p class="text-sm text-gray-800 font-semibold">WhatsApp: +92 311 518 9291</p>
                <p class="text-sm text-gray-800 font-semibold">E-mail: munashirmehdi@mail.com</p>
            </div>
            
            <div class="border-t border-b border-gray-300 py-3 my-3">
                <div class="space-y-2">
                    <p class="text-sm text-gray-800 font-bold">GBDRYFRUITS</p>
                    <p class="text-sm text-gray-600"><strong>JazzCash Account:</strong> 03115189291</p>
                    <p class="text-sm text-gray-600"><strong>Account Name:</strong> Mubashir Mehdi</p>
                    <p class="text-sm text-gray-600"><strong>Amount:</strong> <span id="jazzcashAmount">Rs. 0</span></p>
                </div>
            </div>
            
            <div class="bg-blue-50 border border-blue-200 p-3 rounded-lg mb-3">
                <p class="text-sm text-blue-800"><strong>How to pay:</strong></p>
                <ol class="text-sm text-blue-700 mt-2 space-y-1">
                    <li>1. Open your JazzCash app</li>
                    <li>2. Select "Send Money"</li>
                    <li>3. Enter number: 03115189291</li>
                    <li>4. Enter amount and send</li>
                    <li>5. Screenshot the transaction</li>
                </ol>
            </div>
            
            <div class="bg-yellow-50 border border-yellow-200 p-3 rounded-lg mb-4">
                <p class="text-sm text-yellow-800"><strong>Note:</strong> Your order will be processed after payment confirmation. Thanks</p>
            </div>
            
            <div class="flex justify-end space-x-3">
                <button onclick="closeJazzcashModal()" class="btn-secondary">Close</button>
                <button onclick="confirmJazzcash()" class="btn-primary">Continue to Review ‚Üí</button>
            </div>
        </div>
    </div>

    <!-- EasyPaisa Payment Modal -->
    <div id="easypaisaModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden">
        <div class="bg-white rounded-xl p-6 max-w-md w-full mx-4 max-h-[90vh] overflow-y-auto">
            <h3 class="text-lg font-bold text-gray-900 mb-3">INSTRUCTIONS FOR EASYPAYSA PAYMENT:</h3>
            <p class="text-sm text-gray-600 mb-3">Please transfer the order amount via EasyPaisa and WhatsApp or E-mail the transaction screenshot to confirm your order.</p>
            
            <div class="bg-gray-50 p-3 rounded-lg space-y-2 mb-3">
                <p class="text-sm text-gray-800 font-semibold">WhatsApp: +92 311 518 9291</p>
                <p class="text-sm text-gray-800 font-semibold">E-mail: munashirmehdi@mail.com</p>
            </div>
            
            <div class="border-t border-b border-gray-300 py-3 my-3">
                <div class="space-y-2">
                    <p class="text-sm text-gray-800 font-bold">GBDRYFRUITS</p>
                    <p class="text-sm text-gray-600"><strong>EasyPaisa Account:</strong> 03115189291</p>
                    <p class="text-sm text-gray-600"><strong>Account Name:</strong> Mubashir Mehdi</p>
                    <p class="text-sm text-gray-600"><strong>Amount:</strong> <span id="easypaisaAmount">Rs. 0</span></p>
                </div>
            </div>
            
            <div class="bg-green-50 border border-green-200 p-3 rounded-lg mb-3">
                <p class="text-sm text-green-800"><strong>How to pay:</strong></p>
                <ol class="text-sm text-green-700 mt-2 space-y-1">
                    <li>1. Open your EasyPaisa app</li>
                    <li>2. Select "Send Money"</li>
                    <li>3. Enter number: 03115189291</li>
                    <li>4. Enter amount and send</li>
                    <li>5. Screenshot the transaction</li>
                </ol>
            </div>
            
            <div class="bg-yellow-50 border border-yellow-200 p-3 rounded-lg mb-4">
                <p class="text-sm text-yellow-800"><strong>Note:</strong> Your order will be processed after payment confirmation. Thanks</p>
            </div>
            
            <div class="flex justify-end space-x-3">
                <button onclick="closeEasypaisaModal()" class="btn-secondary">Close</button>
                <button onclick="confirmEasypaisa()" class="btn-primary">Continue to Review ‚Üí</button>
            </div>
        </div>
    </div>

    <!-- Meezan Bank Payment Modal -->
    <div id="meezanModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden">
        <div class="bg-white rounded-xl p-8 max-w-md w-full mx-4">
            <h3 class="text-xl font-bold text-gray-900 mb-4">Meezan Bank Payment</h3>
            <div class="bg-indigo-50 p-4 rounded-lg space-y-2">
                <p class="text-gray-600"><strong>Bank:</strong> Meezan Bank</p>
                <p class="text-gray-600"><strong>Account Title:</strong> Mubashir Mehdi</p>
                <p class="text-gray-600"><strong>Account Number:</strong> 03810104256225</p>
                <p class="text-gray-600"><strong>Branch Code:</strong> 0123</p>
                <p class="text-gray-600"><strong>IBAN:</strong> PK45MEZN0001234567890123</p>
            </div>
            <div class="bg-yellow-50 border border-yellow-200 p-3 rounded-lg mt-4">
                <p class="text-sm text-yellow-800"><strong>Payment Methods:</strong></p>
                <ul class="text-sm text-yellow-700 mt-2 space-y-1">
                    <li>‚Ä¢ Meezan Bank Mobile App</li>
                    <li>‚Ä¢ Internet Banking</li>
                    <li>‚Ä¢ ATM Transfer</li>
                    <li>‚Ä¢ Bank Branch Deposit</li>
                </ul>
            </div>
            <div class="flex justify-end mt-6 space-x-3">
                <button onclick="closeMeezanModal()" class="btn-secondary">Close</button>
                <button onclick="confirmMeezan()" class="btn-primary">Continue to Review ‚Üí</button>
            </div>
        </div>
    </div>

    <!-- COD Charge Modal -->
    <div id="codModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden">
        <div class="bg-white rounded-xl p-8 max-w-md w-full mx-4">
            <h3 class="text-xl font-bold text-gray-900 mb-4">Cash on Delivery - Additional Charge</h3>
            <div class="bg-yellow-50 border border-yellow-200 p-4 rounded-lg">
                <p class="text-sm text-yellow-800"><strong>Important Information:</strong></p>
                <p class="text-sm text-yellow-700 mt-2">When selecting the Cash on Delivery payment method, please note that an additional cost of Rs. 250 will be added to your order total. This is a standard charge that applies to all orders and ensures that we can continue to offer this convenient payment option to our customers.</p>
                <p class="text-sm text-yellow-700 mt-2">We want to make sure you're aware of this cost upfront, so you can make an informed decision when choosing your payment method. If you have any questions or concerns about this charge, please don't hesitate to contact our customer support team.</p>
                <p class="text-sm text-yellow-700 mt-2">Thank you for choosing our store, and we appreciate your understanding and support!</p>
            </div>
            <div class="mt-4">
                <p class="text-gray-600"><strong>Additional Charge:</strong> Rs. 250</p>
                <p class="text-gray-600"><strong>New Total:</strong> <span id="codNewTotal">Rs. 0</span></p>
            </div>
            <div class="flex justify-end mt-6 space-x-3">
                <button onclick="closeCodModal()" class="btn-secondary">Choose Another Method</button>
                <button onclick="confirmCod()" class="btn-primary">Accept & Continue</button>
            </div>
        </div>
    </div>

    <!-- Payment Confirmation Modal -->
    <div id="paymentConfirmationModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden">
        <div class="bg-white rounded-xl p-8 max-w-md w-full mx-4">
            <h3 class="text-xl font-bold text-gray-900 mb-4">Payment Confirmation</h3>
            <div class="bg-yellow-50 border border-yellow-200 p-4 rounded-lg">
                <p class="text-sm text-yellow-800"><strong>Important:</strong></p>
                <p class="text-sm text-yellow-700 mt-2">Your order will be processed after payment verification. This usually takes 5-30 minutes during business hours.</p>
            </div>
            <div class="mt-4">
                <p class="text-sm text-gray-600"><strong>Payment Method:</strong> <span id="confirmPaymentMethod">JazzCash</span></p>
                <p class="text-sm text-gray-600"><strong>Amount:</strong> <span id="confirmAmount">Rs. 0</span></p>
                <p class="text-sm text-gray-600"><strong>Order Number:</strong> <span id="confirmOrderNumber">Will be assigned</span></p>
            </div>
            <div class="bg-blue-50 p-3 rounded-lg mt-4">
                <p class="text-sm text-blue-800"><strong>Next Steps:</strong></p>
                <ol class="text-sm text-blue-700 mt-2 space-y-1">
                    <li>1. We'll verify your payment</li>
                    <li>2. You'll receive confirmation via WhatsApp/Email</li>
                    <li>3. Your order will be processed for delivery</li>
                </ol>
            </div>
            <div class="flex justify-end mt-6 space-x-3">
                <button onclick="closePaymentConfirmation()" class="btn-secondary">Cancel</button>
                <button onclick="confirmPayment()" class="btn-primary">Confirm Payment Sent</button>
            </div>
        </div>
    </div>

    <!-- Success Modal -->
    <div id="successModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden">
        <div class="bg-white rounded-xl p-8 max-w-md w-full mx-4">
            <div class="text-center">
                <div class="w-16 h-16 bg-green-600 rounded-full flex items-center justify-center mx-auto mb-4">
                    <svg class="w-8 h-8 text-white" fill="currentColor" viewBox="0 0 20 20">
                        <path fill-rule="evenodd" d="M16.707 5.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 0l-8 8a1 1 0 101.414 1.414L8.586 10l1.293 1.293a1 1 0 001.414-1.414l8-8z" clip-rule="evenodd"/>
                    </svg>
                </div>
                <h3 class="text-2xl font-bold text-gray-900 mb-2">Order Placed Successfully!</h3>
                <p class="text-gray-600 mb-6">Your order has been confirmed. You will receive a confirmation email shortly.</p>
                <div class="space-y-3">
                    <div class="p-3 bg-gray-50 rounded-lg">
                        <p class="text-sm text-gray-600">Order Number</p>
                        <p class="font-bold text-lg" id="orderNumber">#GBDRY-000000</p>
                    </div>
                    <div id="whatsappButton" class="hidden">
                        <button onclick="sendWhatsAppConfirmation()" class="w-full px-4 py-3 bg-green-600 hover:bg-green-700 text-white font-medium rounded-lg transition-colors">
                            Send WhatsApp Confirmation
                        </button>
                    </div>
                    <button onclick="closeSuccessModal()" class="w-full px-4 py-3 bg-green-600 hover:bg-green-700 text-white font-medium rounded-lg transition-colors">
                        Continue Shopping
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Global state
        let currentStep = 1;
        let selectedPaymentMethod = null;
        let orderData = {
            shipping: {},
            payment: {},
            items: [],
            totals: {}
        };

        // Initialize Stripe
        const stripe = Stripe('pk_test_51234567890abcdef123456789');

        // Load cart data from localStorage
        function loadCartData() {
            const cartData = localStorage.getItem('cart') || localStorage.getItem('cartData');
            if (cartData) {
                orderData.items = JSON.parse(cartData);
                updateOrderSummary();
                updateSidebarItems();
            }
        }

        // Update order summary
        function updateOrderSummary() {
            let subtotal = 0;
            const itemsHtml = orderData.items.map(item => {
                subtotal += item.price * item.quantity;
                return `
                    <div class="flex justify-between items-center py-3 border-b border-gray-100">
                        <div class="flex items-center space-x-3">
                            <img src="${item.image}" alt="${item.name}" class="w-12 h-12 object-cover rounded media-large">
                            <div>
                                <p class="font-medium text-gray-900">${item.name}</p>
                                <p class="text-sm text-gray-600">${item.weight} √ó ${item.quantity}</p>
                            </div>
                        </div>
                        <span class="font-semibold">Rs. ${(item.price * item.quantity).toLocaleString()}</span>
                    </div>
                `;
            }).join('');
            
            document.getElementById('reviewOrderItems').innerHTML = itemsHtml;
            document.getElementById('sidebarOrderItems').innerHTML = itemsHtml;
            
            orderData.totals.subtotal = subtotal;
            orderData.totals.shipping = 0; // Free shipping - COD charges handled separately
            orderData.totals.total = subtotal + orderData.totals.shipping;
            
            updateTotals();
        }

        // Update totals display
        function updateTotals() {
            const subtotalElement = document.getElementById('sidebarSubtotal');
            const shippingElement = document.getElementById('sidebarShipping');
            const totalElement = document.getElementById('sidebarTotal');
            
            if (subtotalElement) subtotalElement.textContent = `Rs. ${orderData.totals.subtotal.toLocaleString()}`;
            if (shippingElement) shippingElement.textContent = orderData.totals.shipping === 0 ? 'FREE' : `Rs. ${orderData.totals.shipping.toLocaleString()}`;
            if (totalElement) totalElement.textContent = `Rs. ${orderData.totals.total.toLocaleString()}`;
        }

        // Proceed to payment
        function proceedToPayment() {
            const form = document.getElementById('shippingForm');
            const formData = new FormData(form);
            
            orderData.shipping = {
                firstName: formData.get('firstName'),
                lastName: formData.get('lastName'),
                email: formData.get('email'),
                phone: formData.get('countryCode') + ' ' + formData.get('phone'),
                address: formData.get('address'),
                city: formData.get('city'),
                postalCode: formData.get('postalCode'),
                instructions: formData.get('instructions')
            };
            
            // Update step indicators
            updateStep(2);
            
            // Show payment step
            document.getElementById('shippingStep').classList.add('hidden');
            document.getElementById('paymentStep').classList.remove('hidden');
        }

        // Select payment method
        function selectPaymentMethod(method) {
            selectedPaymentMethod = method;
            
            // Update UI
            document.querySelectorAll('.payment-option').forEach(el => {
                el.classList.remove('selected');
            });
            event.currentTarget.classList.add('selected');
            
            // Update shipping based on payment method
            updateShippingDisplay(method);
            
            // Show the Continue to Review button in sidebar immediately
            document.getElementById('sidebarContinueButton').style.display = 'block';
            
            // Show appropriate payment modal
            if (method === 'bank-transfer') {
                showBankTransferModal();
            } else if (method === 'jazzcash') {
                showJazzcashModal();
            } else if (method === 'easypaisa') {
                showEasypaisaModal();
            } else if (method === 'meezan') {
                showMeezanModal();
            } else if (method === 'cod') {
                showCodModal();
            }
        }

        // Update shipping display based on payment method
        function updateShippingDisplay(paymentMethod) {
            const shippingElement = document.getElementById('sidebarShipping');
            const totalElement = document.getElementById('sidebarTotal');
            const subtotalElement = document.getElementById('sidebarSubtotal');
            const sidebarContinueButton = document.getElementById('sidebarContinueButton');
            
            // Get current subtotal from the displayed value
            const subtotalText = subtotalElement.textContent || 'Rs. 0';
            const currentSubtotal = parseFloat(subtotalText.replace('Rs. ', '').replace(',', '')) || 0;
            
            let shippingCost = 0;
            let shippingText = '';
            let shippingColor = '';
            
            switch(paymentMethod) {
                case 'cod':
                    shippingCost = 250;
                    shippingText = 'Rs. 250';
                    shippingColor = 'text-orange-600';
                    break;
                case 'bank-transfer':
                case 'jazzcash':
                case 'easypaisa':
                case 'meezan':
                    shippingCost = 0;
                    shippingText = 'FREE';
                    shippingColor = 'text-green-600';
                    break;
                default:
                    shippingText = 'Select Payment Method';
                    shippingColor = 'text-gray-600';
                    sidebarContinueButton.style.display = 'none';
                    return;
            }
            
            // Update shipping display
            shippingElement.textContent = shippingText;
            shippingElement.className = `font-medium ${shippingColor}`;
            
            // Update total
            const newTotal = currentSubtotal + shippingCost;
            totalElement.textContent = 'Rs. ' + newTotal;
            
            // Update order data
            if (orderData.tottots) {
                orderData.tottots.shipping = shippingCost;
                orderData.tottots.total = newTotal;
            }
            
            // Show the Continue to Review button in sidebar
            sidebarContinueButton.style.display = 'block';
        }

        // Proceed to review
        function proceedToReview() {
            if (!selectedPaymentMethod) {
                alert('Please select a payment method');
                return;
            }
            
            orderData.payment.method = selectedPaymentMethod;
            
            // Update step indicators
            updateStep(3);
            
            // Show review step
            document.getElementById('paymentStep').classList.add('hidden');
            document.getElementById('reviewStep').classList.remove('hidden');
            
            // Update sidebar buttons: hide Continue to Review, show Place Order
            document.getElementById('sidebarContinueButton').style.display = 'none';
            document.getElementById('sidebarPlaceOrderButton').style.display = 'block';
            
            // Update review sections
            updateReviewSections();
        }

        // Update review sections
        function updateReviewSections() {
            // Update shipping details
            const shippingHtml = `
                <p><strong>Name:</strong> ${orderData.shipping.firstName} ${orderData.shipping.lastName}</p>
                <p><strong>Email:</strong> ${orderData.shipping.email}</p>
                <p><strong>Phone:</strong> ${orderData.shipping.phone}</p>
                <p><strong>Address:</strong> ${orderData.shipping.address}</p>
                <p><strong>City:</strong> ${orderData.shipping.city}</p>
                <p><strong>Postal Code:</strong> ${orderData.shipping.postalCode}</p>
            `;
            document.getElementById('reviewShippingDetails').innerHTML = shippingHtml;
        }

        // Navigation functions
        function goBackToShipping() {
            updateStep(1);
            document.getElementById('paymentStep').classList.add('hidden');
            document.getElementById('shippingStep').classList.remove('hidden');
        }

        function goBackToPayment() {
            updateStep(2);
            document.getElementById('reviewStep').classList.add('hidden');
            document.getElementById('paymentStep').classList.remove('hidden');
        }

        // Update step indicators
        function updateStep(step) {
            currentStep = step;
            
            for (let i = 1; i <= 3; i++) {
                const stepEl = document.getElementById(`step${i}`);
                const lineEl = stepEl.parentElement.nextElementSibling;
                
                if (i <= step) {
                    stepEl.classList.add('active');
                    stepEl.classList.remove('bg-gray-200', 'text-gray-500');
                    stepEl.classList.add('text-white');
                    
                    if (lineEl && lineEl.classList.contains('step-line')) {
                        lineEl.classList.add('active');
                    }
                } else {
                    stepEl.classList.remove('active');
                    stepEl.classList.add('bg-gray-200', 'text-gray-500');
                    stepEl.classList.remove('text-white');
                    
                    if (lineEl && lineEl.classList.contains('step-line')) {
                        lineEl.classList.remove('active');
                    }
                }
                
                // Update text colors
                const textContainer = stepEl.nextElementSibling;
                if (textContainer) {
                    const texts = textContainer.querySelectorAll('div');
                    texts.forEach(text => {
                        if (i <= step) {
                            text.classList.remove('text-gray-500');
                            text.classList.add('text-gray-900');
                        } else {
                            text.classList.remove('text-gray-900');
                            text.classList.add('text-gray-500');
                        }
                    });
                }
            }
        }

        // Place order
        async function placeOrder() {
            showLoading();
            
            try {
                console.log('Starting order placement...');
                console.log('Order data:', orderData);
                
                // Try backend first, fallback to localStorage if backend is not available
                let backendAvailable = false;
                const userToken = localStorage.getItem('token');
                
                try {
                    // Test if backend is available
                    const testResponse = await fetch('http://localhost:5000/health');
                    backendAvailable = testResponse.ok;
                } catch (error) {
                    console.log('Backend not available, using localStorage fallback');
                }
                
                if (backendAvailable) {
                    // Backend is available, try to create order
                    // Prepare order data for backend
                    const orderPayload = {
                        orderItems: orderData.items.map(item => ({
                            name: item.name,
                            quantity: item.quantity,
                            price: item.price,
                            product: item._id || item.id
                        })),
                        shippingAddress: {
                            name: `${orderData.shipping.firstName} ${orderData.shipping.lastName}`,
                            phone: orderData.shipping.phone,
                            address: orderData.shipping.address,
                            city: orderData.shipping.city,
                            state: orderData.shipping.city,
                            zipCode: orderData.shipping.postalCode || '00000',
                            country: 'Pakistan'
                        },
                        paymentMethod: selectedPaymentMethod === 'cod' ? 'Cash on Delivery' : 
                                       selectedPaymentMethod === 'jazzcash' ? 'JazzCash' :
                                       selectedPaymentMethod === 'easypaisa' ? 'EasyPaisa' :
                                       selectedPaymentMethod === 'meezan' ? 'Meezan Bank' :
                                       selectedPaymentMethod === 'bank-transfer' ? 'Bank Transfer' :
                                       selectedPaymentMethod === 'visa' || selectedPaymentMethod === 'mastercard' ? 'Bank Card' :
                                       selectedPaymentMethod === 'unionpay' ? 'UnionPay' :
                                       selectedPaymentMethod,
                        notes: orderData.shipping.instructions || ''
                    };
                    
                    console.log('Order payload:', orderPayload);

                    // Send order to backend
                    const headers = { 'Content-Type': 'application/json' };
                    if (userToken) headers['Authorization'] = `Bearer ${userToken}`;

                    const response = await fetch('http://localhost:5000/api/orders', {
                        method: 'POST',
                        headers,
                        body: JSON.stringify(orderPayload)
                    });

                    console.log('Order response status:', response.status);

                    if (response.ok) {
                        const result = await response.json();
                        console.log('Order created successfully:', result);
                        
                        // Clear cart from localStorage
                        localStorage.removeItem('cart');
                        localStorage.removeItem('cartData');
                        
                        // Update cart count if elements exist
                        document.querySelectorAll('.cart-count').forEach(el => el.textContent = '0');
                        
                        // Generate order number from backend response
                        const orderNumber = result.order._id ? `GBDRY-${result.order._id.slice(-6)}` : 'GBDRY-' + Date.now().toString().slice(-6);
                        document.getElementById('orderNumber').textContent = `#${orderNumber}`;
                        
                        // Show WhatsApp button for COD orders
                        if (selectedPaymentMethod === 'cod') {
                            document.getElementById('whatsappButton').classList.remove('hidden');
                        }
                        
                        hideLoading();
                        showSuccessModal();
                        return;
                    } else {
                        const error = await response.json().catch(() => ({}));
                        console.error('Order creation failed:', error);
                        hideLoading();
                        alert('Order failed: ' + (error.message || (error.errors && error.errors[0] && error.errors[0].msg) || 'Please check backend logs and try again.'));
                        return;
                    }
                }
                
                // Fallback: Save order to localStorage
                console.log('Using localStorage fallback for order');
                
                const createdOrder = {
                    id: 'GBDRY-' + Date.now().toString().slice(-6),
                    customer: {
                        name: `${orderData.shipping.firstName} ${orderData.shipping.lastName}`,
                        email: orderData.shipping.email,
                        phone: orderData.shipping.phone,
                        address: orderData.shipping.address,
                        city: orderData.shipping.city
                    },
                    items: orderData.items,
                    totals: orderData.totals,
                    paymentMethod: selectedPaymentMethod,
                    status: 'Pending',
                    createdAt: new Date().toISOString()
                };
                
                // Save to localStorage orders array
                const existingOrders = JSON.parse(localStorage.getItem('orders') || '[]');
                existingOrders.push(createdOrder);
                localStorage.setItem('orders', JSON.stringify(existingOrders));
                
                // Clear cart from localStorage
                localStorage.removeItem('cart');
                localStorage.removeItem('cartData');
                
                // Update cart count if elements exist
                document.querySelectorAll('.cart-count').forEach(el => el.textContent = '0');
                
                // Generate order number
                document.getElementById('orderNumber').textContent = `#${createdOrder.id}`;
                
                // Show WhatsApp button for COD orders
                if (selectedPaymentMethod === 'cod') {
                    document.getElementById('whatsappButton').classList.remove('hidden');
                }
                
                hideLoading();
                showSuccessModal();
                
            } catch (error) {
                console.error('Error placing order:', error);
                alert('Order failed: ' + error.message + '. Please try again.');
                hideLoading();
            }
        }

        // Loading functions
        function showLoading() {
            document.getElementById('loadingOverlay').classList.remove('hidden');
        }

        function hideLoading() {
            document.getElementById('loadingOverlay').classList.add('hidden');
        }

        // Success modal functions
        function showSuccessModal() {
            document.getElementById('successModal').classList.remove('hidden');
        }

        function closeSuccessModal() {
            document.getElementById('successModal').classList.add('hidden');
            window.location.href = 'index.html';
        }

        // WhatsApp confirmation
        function sendWhatsAppConfirmation() {
            const orderNumber = document.getElementById('orderNumber').textContent;
            const message = `Hello! I've placed order ${orderNumber} for ${orderData.totals.total} PKR. Please confirm delivery details. Thank you!`;
            const whatsappUrl = `https://wa.me/923115189291?text=${encodeURIComponent(message)}`;
            window.open(whatsappUrl, '_blank');
        }

        // Payment confirmation functions
        function showPaymentConfirmation(paymentMethod) {
            document.getElementById('confirmPaymentMethod').textContent = paymentMethod;
            document.getElementById('confirmAmount').textContent = orderData.tottots.total;
            document.getElementById('paymentConfirmationModal').classList.remove('hidden');
        }

        function closePaymentConfirmation() {
            document.getElementById('paymentConfirmationModal').classList.add('hidden');
        }

        function confirmPayment() {
            closePaymentConfirmation();
            placeOrder();
        }

        // Bank transfer modal functions
        function showBankTransferModal() {
            document.getElementById('bankTransferModal').classList.remove('hidden');
        }

        function closeBankTransferModal() {
            document.getElementById('bankTransferModal').classList.add('hidden');
        }

        function confirmBankTransfer() {
            closeBankTransferModal();
            showPaymentConfirmation('Bank Transfer');
        }

        // JazzCash modal functions
        function showJazzcashModal() {
            document.getElementById('jazzcashAmount').textContent = orderData.totals.total;
            document.getElementById('jazzcashModal').classList.remove('hidden');
        }

        function closeJazzcashModal() {
            document.getElementById('jazzcashModal').classList.add('hidden');
        }

        function confirmJazzcash() {
            closeJazzcashModal();
            showPaymentConfirmation('JazzCash');
        }

        // EasyPaisa modal functions
        function showEasypaisaModal() {
            document.getElementById('easypaisaAmount').textContent = orderData.totals.total;
            document.getElementById('easypaisaModal').classList.remove('hidden');
        }

        function closeEasypaisaModal() {
            document.getElementById('easypaisaModal').classList.add('hidden');
        }

        function confirmEasypaisa() {
            closeEasypaisaModal();
            showPaymentConfirmation('EasyPaisa');
        }

        // Meezan Bank modal functions
        function showMeezanModal() {
            document.getElementById('meezanModal').classList.remove('hidden');
        }

        function closeMeezanModal() {
            document.getElementById('meezanModal').classList.add('hidden');
        }

        function confirmMeezan() {
            closeMeezanModal();
            proceedToReview(); // Go to review step like EasyPaisa
        }

        // COD modal functions
        function showCodModal() {
            const currentTotal = orderData.tottots.total;
            const newTotal = currentTotal + 250;
            document.getElementById('codNewTotal').textContent = 'Rs. ' + newTotal;
            document.getElementById('codModal').classList.remove('hidden');
        }

        function closeCodModal() {
            document.getElementById('codModal').classList.add('hidden');
        }

        function confirmCod() {
            closeCodModal();
            // Add COD charge to order total
            orderData.tottots.total += 250;
            orderData.tottots.shipping = (orderData.tottots.shipping || 0) + 250;
            
            // Update shipping display in sidebar
            document.getElementById('sidebarShipping').textContent = 'Rs. 250';
            document.getElementById('sidebarShipping').classList.remove('text-green-600');
            document.getElementById('sidebarShipping').classList.add('text-orange-600');
            
            // Update total display
            document.getElementById('sidebarTotal').textContent = 'Rs. ' + orderData.tottots.total;
            
            proceedToReview();
        }

        // Initialize on page load
        document.addEventListener('DOMContentLoaded', function() {
            loadCartData();
        });
    </script>
</body>
</html>
